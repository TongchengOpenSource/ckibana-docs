<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/">
    <channel>
        <title>ğ‘ªğ‘²ğ’Šğ’ƒğ’‚ğ’ğ’‚ Blog</title>
        <link>http://CKibana.inf.17usoft.com/docs/ckibana-docs/zh/blog</link>
        <description>ğ‘ªğ‘²ğ’Šğ’ƒğ’‚ğ’ğ’‚ Blog</description>
        <lastBuildDate>Tue, 27 Aug 2024 02:54:50 GMT</lastBuildDate>
        <docs>https://validator.w3.org/feed/docs/rss2.html</docs>
        <generator>https://github.com/jpmonette/feed</generator>
        <item>
            <title><![CDATA[å¦‚ä½•åŸºäºåŸç”ŸKibana+Clickhouseæ„å»ºæ—¥å¿—å¹³å°]]></title>
            <link>http://CKibana.inf.17usoft.com/docs/ckibana-docs/zh/blog/build-logging-platform-with-native-kibana-and-clickhouse</link>
            <guid>/build-logging-platform-with-native-kibana-and-clickhouse</guid>
            <pubDate>Tue, 27 Aug 2024 02:54:50 GMT</pubDate>
            <description><![CDATA[å¦‚ä½•åŸºäºåŸç”ŸKibana+Clickhouseæ„å»ºæ—¥å¿—å¹³å°]]></description>
            <content:encoded><![CDATA[<blockquote><p>æœ¬æ–‡å°†ä»‹ç»å¦‚ä½•åŸºäºåŸç”ŸKibana+Clickhouseæ„å»ºæ—¥å¿—å¹³å°</p></blockquote><p>ä¸šåŠ¡å¿«é€Ÿå‘å±•è¿‡ç¨‹ä¸­å¯¹äºå„ç§æ—¥å¿—æ•°æ®çš„æŸ¥è¯¢åˆ†æéœ€æ±‚ä¼šå¯¼è‡´æ—¥å¿—å­˜å‚¨è§„æ¨¡æ€¥å‰§å¢é•¿ï¼Œä¼ ç»ŸELKå’Œä»¥ElasticSearchä¸ºæ ¸å¿ƒå­˜å‚¨çš„æ—¥å¿—ç³»ç»Ÿéšä¹‹ä¼šé¢ä¸´æˆæœ¬ã€ç¨³å®šæ€§ä»¥åŠæ€§èƒ½ç­‰è¯¸å¤šæŒ‘æˆ˜ï¼Œä¸šç•Œä¹Ÿçœ‹åˆ°è¶Šæ¥è¶Šå¤šçš„å›½å†…å¤–å…¬å¸å°†å­˜å‚¨åˆ‡æ¢åˆ°ClickHouseï¼Œæ¯”å¦‚æºç¨‹ã€å¿«æ‰‹ã€Bç«™ã€Cloudflareå’ŒUberç­‰ï¼Œä»ä»–ä»¬çš„åˆ†äº«ä¸­çœ‹åˆ°æ”¶ç›Šéƒ½å¾ˆæ˜æ˜¾ï¼Œæˆ‘ä»¬çš„æ—¥å¿—ç³»ç»Ÿä¹Ÿå¼€å§‹å°è¯•ä»ElasticSearchè¿ç§»åˆ°ClickHouseï¼Œå¹¶åœ¨è¿‡ç¨‹ä¸­æ¢ç´¢å’Œç§¯ç´¯äº†ä¸€å¥—æœ€å¤§ç¨‹åº¦ç…§é¡¾åŸæœ‰ç”¨æˆ·ä½¿ç”¨ä¹ æƒ¯å®ç°å¹³æ»‘åˆ‡æ¢çš„æ•´ä½“æ–¹æ¡ˆã€‚</p><h2>1 èƒŒæ™¯ä»‹ç»</h2><p>æˆ‘ä»¬å…¬å¸å†…éƒ¨æµé‡æœ€å¤§çš„é€šç”¨æ—¥å¿—ç³»ç»Ÿåº•å±‚å­˜å‚¨è‡ªä»2020å¹´ç”±ElasticSearché€æ­¥åˆ‡æ¢åˆ°Clickhouseä¹‹ååœ¨æˆæœ¬ä»¥åŠç¨³å®šæ€§ç­‰æ–¹é¢å‡æœ‰æ˜¾è‘—æå‡ã€‚åœ¨ä»Šå¹´å›½åº†æœŸé—´ç¨³å®šæ”¯æ’‘äº†è¶…è¿‡5000äº¿æ¡/å¤©çš„æ—¥å¿—é‡ï¼Œè€Œæˆæœ¬ä¹Ÿä»…ä»…æ˜¯åŸå…ˆElasticSearchæ–¹æ¡ˆçš„30%ã€‚</p><p>é™¤äº†è¯¥æ—¥å¿—ç³»ç»Ÿå¤–ï¼Œå…¬å¸å†…è¿˜å­˜åœ¨å¾ˆå¤šæ—¥å¿—ç³»ç»Ÿï¼Œå¤§å¤šåŸºäºå¼€æºä¸»æµELKæ–¹å¼ã€‚åœ¨è§„æ¨¡è¶Šæ¥è¶Šå¤§åï¼Œæˆæœ¬è·Ÿç¨³å®šæ€§æ–¹é¢çš„é—®é¢˜ä¹Ÿå°±é€æ¸æš´éœ²äº†ï¼Œæ‰€ä»¥è®¡åˆ’å°†æ‰€æœ‰æ—¥å¿—ç³»ç»Ÿçš„åº•å±‚å­˜å‚¨å…¨éƒ¨åˆ‡æ¢æˆClickHouseã€‚</p><p>å…³äºæ—¥å¿—åœºæ™¯ä¸‹Clickhouseçš„é€‰å‹ä¸ç”¨æ³•ä¸šç•Œå·²ç»æœ‰å¾ˆå¤šçš„å…¬å¼€åˆ†äº«ï¼Œä¸ä½œä¸ºæœ¬æ–‡é‡ç‚¹ï¼Œæœ‰å…´è¶£å¯è‡ªè¡Œæœç´¢ä¸‹ç›¸å…³èµ„æ–™ã€‚</p><p>åœ¨å­˜å‚¨åˆ‡æ¢å®Œæˆä¹‹åæœ€é‡è¦çš„æ˜¯è§£å†³æŸ¥è¯¢UIç”¨æˆ·ä½“éªŒé—®é¢˜ï¼Œä¹Ÿçœ‹åˆ°æœ‰å…¬å¸åœ¨æŠŠæ—¥å¿—å­˜å‚¨åˆ‡åˆ°Clickhouseåé€‰æ‹©è‡ªç ”ä¸€å¥—æŸ¥è¯¢UIï¼Œä½†æƒ³è¦ç…§é¡¾ç”¨æˆ·åŸå…ˆæ‰€æœ‰ä½¿ç”¨ä¹ æƒ¯ä»åŸç”ŸKibanaæ— ç¼åˆ‡æ¢åˆ°æ–°å¹³å°æ˜¯ä¸å¤ªå®ç°çš„ï¼Œéœ€è¦æ‰€æœ‰ä¸šåŠ¡åŒäº‹ç†Ÿæ‚‰ä¸€å¥—æ–°çš„è¯­æ³•è·ŸUIäº¤äº’ï¼Œæ— å½¢ä¸­ç»™ä»–ä»¬åŠ äº†å¾ˆå¤§çš„æˆæœ¬ã€‚</p><p>æ‰€ä»¥ï¼Œæ€ä¹ˆèƒ½å¤Ÿè®©ä¸šåŠ¡ç”¨æˆ·ä»¥é›¶å­¦ä¹ æˆæœ¬ä½¿ç”¨æ–°å¹³å°ï¼Œè¿™æ˜¯ä¸€ä¸ªæœ€æ£˜æ‰‹çš„é—®é¢˜ã€‚</p><h2>2 æ–¹æ¡ˆä»‹ç»</h2><p>æˆ‘ä»¬çš„æ€è·¯å…¶å®ä¹Ÿæ¯”è¾ƒå¯»å¸¸ï¼Œæˆ‘ä»¬é€‰æ‹©åœ¨åŸç”ŸKibanaè·ŸElasticSearchä¹‹é—´æ–°å¢ä¸€å±‚Proxyï¼Œè¯¥Proxyæ¥åšElasticSearchè·ŸClickHouseçš„è¯­æ³•è½¬æ¢ï¼Œå¦‚å›¾:
<img src="https://oss.17usoft.com/infra-github/ckibana02.png" alt="Untitled"/></p><p>æˆ‘ä»¬è‡ªç ”äº†ä¸€å¥—Proxyï¼ˆå–åCKibanaï¼‰ï¼Œè¯¥Proxyè´Ÿè´£å°†å›¾è¡¨è¯·æ±‚è½¬æ¢æˆClickHouseè¯­æ³•æŸ¥è¯¢åˆ°ClickHouseç»“æœåæ¨¡æ‹ŸæˆElasticSearchå“åº”è¿”å›ç»™Kibanaï¼Œè¿™æ ·å°±å¯ä»¥ç›´æ¥åœ¨åŸç”ŸKibanaä¸Šé¢å±•ç¤ºClickHouseä¸­çš„æ•°æ®ï¼Œé™¤äº†è¯­æ³•è½¬æ¢ï¼Œæˆ‘ä»¬è¿˜è§£å†³äº†å¾ˆå¤šå®é™…ä½¿ç”¨è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜ã€‚</p><p><code>CKibana: ç°å·²æ­£å¼å¼€æºï¼Œhttps://github.com/TongchengOpenSource/ckibana</code></p><p>ä»‹äºClickHouseçš„æŸ¥è¯¢å¹¶å‘èƒ½åŠ›é™åˆ¶ï¼Œæˆ‘ä»¬ä¿ç•™äº†ElasticSearchï¼Œè¯¥ElasticSearchå¯ä»¥ç”¨æ¥åšç»“æœçš„ç¼“å­˜ç­‰é«˜çº§ç‰¹æ€§ä»¥åŠä¿å­˜Kibanaç›¸å…³çš„å…ƒæ•°æ®ï¼Œæœ¬èº«éå¸¸è½»é‡ã€‚</p><h2>3 CKibanaä½¿ç”¨</h2><h3>å‡†å¤‡ç¯å¢ƒ</h3><ol><li>Kibana: ç”¨æ¥æä¾›ç»™ä¸šåŠ¡åšUIå±•ç¤º</li><li>ElasticSearch: ç”¨æ¥åškibanaå…ƒæ•°æ®å­˜å‚¨+æŸ¥è¯¢ç¼“å­˜ç­‰é«˜çº§ç‰¹æ€§</li><li>ClickHouse: çœŸå®å­˜æ—¥å¿—æ•°æ®çš„å­˜å‚¨</li><li>CKibana: æä¾›Proxyç­‰é«˜çº§åŠŸèƒ½ï¼Œå®ç°è®©ç”¨æˆ·ç›´æ¥åœ¨åŸç”ŸKibanaä¸ŠæŸ¥è¯¢ClickHouseæ•°æ®</li></ol><h3>å¼€å§‹ä½¿ç”¨</h3><h4>å¯åŠ¨CKibana</h4><p>é…ç½®ElasticSearchç›¸å…³ä¿¡æ¯</p><p><img src="https://oss.17usoft.com/infra-github/ckibana03.png" alt="Untitled"/></p><p>å¯åŠ¨ï¼Œéœ€è¦JDK17+</p><p><code>java -jar ckibana.jar</code></p><h4>ä¿®æ”¹Kibana</h4><p>ä¿®æ”¹Kibanaé…ç½®ï¼Œå°†ElasticSearchåœ°å€æ”¹ä¸ºCKibanaåœ°å€</p><p><img src="https://oss.17usoft.com/infra-github/ckibana04.png" alt="Untitled"/></p><p>æ­¤æ—¶ï¼ŒKibanaåŠŸèƒ½å®Œå…¨å¯ç”¨ï¼Œå¯ä»¥å°†CKibanaå½“æˆä¸€ä¸ªElasticSearch Proxy
<img src="https://oss.17usoft.com/infra-github/ckibana05.png" alt="Untitled"/></p><h4>é…ç½®ClickHouseè¿æ¥ä¿¡æ¯ä¸ç´¢å¼•ç™½åå•</h4><p>è®¾ç½®ClickHouseè¿æ¥ä¿¡æ¯:</p><p><code>curl --location --request POST &#x27;localhost:8080/config/updateCk?url=ckUrl&amp;user=default&amp;pass=default&amp;defaultCkDatabase=ops&#x27;</code></p><h4>é…ç½®éœ€è¦åˆ‡æ¢åˆ°ClickHouseçš„index</h4><p><code>curl --location --request POST &#x27;localhost:8080/config/updateWhiteIndexList?list=index1,index2&#x27;</code></p><p>ClickHouseå­—æ®µè·ŸElasticSearchå­—æ®µçš„å…³ç³»</p><table><thead><tr><th>esç±»å‹</th><th>ckç±»å‹</th></tr></thead><tbody><tr><td>keyword</td><td>String</td></tr><tr><td>text</td><td>String</td></tr><tr><td>ip</td><td>String(ä»£ç†è‡ªåŠ¨è¯†åˆ«ipv4å’Œipv6)</td></tr><tr><td>integer</td><td>Int32</td></tr><tr><td>long</td><td>Int64</td></tr><tr><td>float</td><td>Float32</td></tr><tr><td>double</td><td>Float64</td></tr></tbody></table><h4>åˆ›å»ºindex pattern</h4><p><img src="https://oss.17usoft.com/infra-github/ckibana06.png" alt="Untitled"/></p><p>æ³¨æ„ç‚¹:</p><ol><li>é¦–å…ˆç¡®å®šè¾“å…¥çš„index patternè·ŸClickHouseè¡¨æ˜¯å¦ä¸€è‡´ï¼Œindex patternè·Ÿè·ŸClickHouseè¡¨åæ˜¯ç²¾ç¡®åŒ¹é…</li><li>å¦‚æœä¸èƒ½æ™’é€‰åˆ°å¯¹åº”çš„è¡¨æ ¼ï¼Œå¯ä»¥åŸºäºCKibanaæ—¥å¿—ä¸­çš„sqlæ’æŸ¥ï¼Œæ˜¯å¦å¯æŸ¥è¯¢åˆ°å¯¹åº”çš„è¡¨</li><li>æ³¨æ„æ—¶é—´å­—æ®µï¼Œå¦åˆ™ä¼šç­›é€‰ä¸äº†æ—¶é—´å­—æ®µï¼Œç­›é€‰é€»è¾‘å¦‚ä¸‹:</li></ol><ul><li>å­—æ®µä¸ºDateç±»å‹ï¼Œæ¯”å¦‚DateTime64ç±»å‹ï¼Œä¼šè¢«è®¤ä¸ºæ˜¯æ—¶é—´ç±»å‹</li><li>å­—æ®µåä¸­åŒ…å«timeï¼Œæ¯”å¦‚ï¼ˆ@timestamp UInt64ï¼‰ï¼Œä¼šè¢«è®¤ä¸ºæ˜¯æ—¶é—´ç±»å‹</li></ul><p>è¿™ä¸¤ç§æƒ…å†µä¸‹æ»¡è¶³ä»»æ„ä¸€ä¸ªï¼Œå­—æ®µéƒ½ä¼šè¢«è®¤ä¸ºæ˜¯æ—¶é—´å­—æ®µï¼Œå¦‚æœé€‰æ‹©ä¸äº†æ—¶é—´å­—æ®µï¼Œéœ€è¦æ£€æŸ¥ä¸‹ClickHouseè¡¨ä¸­å­—æ®µæ˜¯å¦ç¬¦åˆåŒ¹é…é€»è¾‘ã€‚</p><h4>å¼€å§‹ä½¿ç”¨</h4><p>é…ç½®å®Œæˆindex patternåï¼Œå°±å¯ä»¥æ­£å¸¸çš„ä½¿ç”¨Kibanaçš„å›¾è¡¨åŠŸèƒ½äº†
<img src="https://oss.17usoft.com/infra-github/ckibana07.png" alt="Untitled"/></p><h3>é«˜çº§åŠŸèƒ½</h3><h4>é‡‡æ ·</h4><p>Kibanaçš„å›¾è¡¨å¤§éƒ¨åˆ†éƒ½æ˜¯å…³æ³¨è¶‹åŠ¿ï¼Œå½“å‘½ä¸­ç»“æœé›†å¤ªå¤§æ—¶å€™ï¼Œæ¶ˆè€—çš„ClickHouseçš„èµ„æºä¹Ÿè¾ƒå¤šã€‚æˆ‘ä»¬æä¾›äº†é‡‡æ ·åŠŸèƒ½ï¼Œåœ¨æ•°æ®é›†è¾ƒå¤§çš„æ—¶å€™ï¼Œèƒ½å¤Ÿä¿éšœå›¾è¡¨è¶‹åŠ¿è·Ÿå®é™…çš„å·®ä¸å¤šï¼Œè€Œä¸”å¯ä»¥å¾ˆå¥½çš„æ§åˆ¶ClickHouseçš„èµ„æºä½¿ç”¨ã€‚</p><p>`- æ³¨: å¯¹åº”çš„ClickHouseçš„è¡¨éœ€è¦æŒ‰ç…§ckçš„é‡‡æ ·è¡¨åˆ›å»º <a href="https://clickhouse.com/docs/en/sql-reference/statements/select/sample">clickhouse sample</a></p><ul><li>å¦‚æœé‡‡æ ·é˜ˆå€¼è®¾ç½®çš„è¿‡å°ï¼Œä¼šå¯¼è‡´è¿˜åŸå‡ºæ¥çš„å€¼è·ŸçœŸå®å€¼å·®å¼‚è¾ƒå¤§ï¼Œæˆ‘ä»¬çº¿ä¸Šè®¾ç½®çš„é‡‡æ ·å€¼ä¸º500w`</li></ul><p>å¼€å¯é‡‡æ ·éœ€è¦ä¸¤æ­¥:</p><ol><li>é…ç½®éœ€è¦é‡‡æ ·çš„è¡¨</li><li>æ›´æ–°é‡‡æ ·é˜ˆå€¼ï¼Œå½“å‘½ä¸­ç»“æœé›†è¶…è¿‡é˜ˆå€¼æ—¶ï¼Œä¼šè§¦å‘é‡‡æ ·</li></ol><p>é‡‡æ ·é€»è¾‘ <code>Math.max(0.01, Double.parseDouble(String.format(&quot;%.5f&quot;, sampleParam.getSampleCountMaxThreshold() * 1.00 / sampleParam.getSampleTotalCount())))</code></p><p><img src="https://oss.17usoft.com/infra-github/ckibana08.png" alt="Untitled"/></p><p>å±•å¼€æµé‡å™¨çš„å“åº”ç»“æœï¼Œå¯ä»¥çœ‹åˆ°é‡‡æ ·å€¼</p><h4>æ—¶é—´round+ç¼“å­˜</h4><p>å½“çº¿ä¸Šå‡ºç°ä¸€ä¸ªæ•…éšœæ—¶å€™ï¼Œæœ‰å¤§é‡çš„sreåŒå­¦è·Ÿä¸šåŠ¡åŒå­¦éƒ½éœ€è¦é€šè¿‡nginxæ—¥å¿—æ¥æŸ¥è¯¢é—®é¢˜ï¼Œè€Œä¸”æŸ¥è¯¢çš„æ¡ä»¶åŸºæœ¬éƒ½ç›¸åŒï¼Œä½†æ˜¯ClickHouseä¸ºäº†ä½¿å¾—æŸ¥è¯¢æ€§èƒ½æœ€å¥½ï¼Œè€Œå°½é‡çš„ä½¿ç”¨æ›´å¤šçš„cpuæ¥å‚åŠ è®¡ç®—ï¼Œè¿™æ ·å¯¼è‡´è¿™äº›åœºæ™¯ä¸‹ClickHouseçš„cpuä¼šç›´æ¥è·‘æ»¡ã€‚ä¸”åœ¨åŒå­¦ä»¬çš„ä¸æ–­retryä¸‹ï¼Œcpuä¸èƒ½æ¢å¤ã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬åšäº†ä¸€ä¸ªæ—¶é—´round+ç¼“å­˜åŠŸèƒ½ã€‚</p><p>æ—¶é—´round: æ¯”å¦‚è®¾ç½®roundä¸º20sï¼Œåˆ™æŸ¥è¯¢æ—¶é—´æ¡ä»¶ä¸­çš„sçš„ç²¾åº¦ä¼š<code>%20</code>ï¼Œç›¸å½“äºæœ€å¤šå»¶è¿Ÿäº†20sæ¥æŸ¥è¯¢æ•°æ®ã€‚</p><p>æœ‰äº†æ—¶é—´roundåï¼Œåˆ™å¤§é‡çš„æŸ¥è¯¢æ¡ä»¶å°±ä¸€è‡´äº†ï¼Œè¿™ä¸ªæ—¶å€™åªéœ€è¦å¼€å¯ç»“æœç¼“å­˜ï¼Œåˆ™å°±å¯ä»¥å¾ˆå¥½çš„ç¼“è§£ClickHouseçš„å‹åŠ›ã€‚</p><p>è®¾ç½®æ—¶é—´round:
<code>curl --location --request POST &#x27;localhost:8080/config/updateRoundAbleMinPeriod?roundAbleMinPeriod=20000&#x27; å•ä½ms</code></p><p>è®¾ç½®æ‰“å¼€ç¼“å­˜:
<code>curl --location --request POST &#x27;localhost:8080/config/updateUseCache?useCache=true&#x27;</code>
<img src="https://oss.17usoft.com/infra-github/ckibana09.png" alt="Untitled"/></p><p>æ˜¯å¦å‘½ä¸­ç¼“å­˜ï¼Œåœ¨å“åº”ç»“æ„é‡Œé¢å¯ä»¥çœ‹åˆ°</p><h4>æŸ¥è¯¢ç›‘æ§ + é»‘åå•</h4><p>Kibanaçš„æŸ¥è¯¢è¯­æ³•ç›¸å¯¹æ¯”è¾ƒéšæ„ï¼Œä¸€äº›æŸ¥è¯¢å¯¹ClickHouseçš„èµ„æºæ¶ˆè€—ä¼šæ¯”è¾ƒå¤§ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†æ‰€æœ‰çš„æŸ¥è¯¢ä»¥åŠè€—æ—¶éƒ½åšäº†ç›‘æ§ï¼Œè¿™æ ·å¯ä»¥æ¯”è¾ƒæ–¹ä¾¿çš„æŸ¥çœ‹éƒ½åšäº†å“ªäº›æŸ¥è¯¢ï¼Œè®¾ç½®å¯ä»¥å¯¹æŸ¥è¯¢åšé»‘åå•çš„æ§åˆ¶ï¼Œè¿™æ ·å°±å¯ä»¥é™åˆ¶ä¸å¤ªå‹å¥½çš„æŸ¥è¯¢</p><p>å¼€å¯ç›‘æ§:</p><p><code>curl --location --request POST &#x27;localhost:8080/config/updateEnableMonitoring?enableMonitoring=true&#x27;</code></p><p><img src="https://oss.17usoft.com/infra-github/ckibana10.png" alt="Untitled"/></p><p>å¦‚ä¸Šå›¾ï¼Œæˆ‘ä»¬å¯ä»¥ç›‘æ§æ¯ä¸ªæŸ¥è¯¢çš„è¯¦æƒ…ï¼Œè¯­æ³•ä»¥åŠè€—æ—¶ã€‚</p><p><img src="https://oss.17usoft.com/infra-github/ckibana11.png" alt="Untitled"/></p><p>å¦‚ä¸Šå›¾ï¼Œå¯ä»¥åŸºäºkibanaå›¾è¡¨åŠŸèƒ½ï¼Œåšæ›´ç›´è§‚çš„åˆ†æã€‚</p><h4>æŸ¥è¯¢æ—¶é—´é™åˆ¶</h4><p>å¾ˆå¤šæ—¶å€™ï¼Œæœ‰äººæƒ³è¦æŸ¥çœ‹æŸä¸ªæ¡ä»¶æœ€è¿‘çš„è¶‹åŠ¿ï¼Œç›´æ¥æŸ¥è¯¢æœ€è¿‘7å¤©ç­‰ç­‰ï¼Œè¿™æ ·ä¼šå¯¼è‡´èµ„æºæ¶ˆè€—æ¯”è¾ƒå¤§ï¼Œæ‰€ä»¥CKibanaæ”¯æŒäº†æœ€é•¿æ—¶é—´æŸ¥è¯¢èŒƒå›´ï¼Œæ¥é™åˆ¶ä½¿ç”¨ã€‚</p><p><code>curl --location --request POST &#x27;localhost:8080/config/updateMaxTimeRange?maxTimeRange=864000000&#x27; å•ä½ms</code></p><h4>keywordæŸ¥è¯¢</h4><p>ä¸ºäº†æ›´å¥½çš„åŒ¹é…ElasticSearchçš„ä½¿ç”¨ä¹ æƒ¯ã€‚ <code>field.keyword</code> æŸ¥è¯¢ç›¸å½“äºå¯¹fieldçš„ç²¾ç¡®æŸ¥è¯¢ï¼Œå¦åˆ™ä¸ºæ¨¡ç³Šæœç´¢</p><p>æ¯”å¦‚ <code>host.keyword:&quot;www.baidu.com&quot;</code> æ¢æˆsqlä¸º: <code>host=&quot;www.baidu.com&quot;</code></p><h4>Discoveræ€§èƒ½ä¼˜åŒ–</h4><p>ClickHouseçš„å¼ºé¡¹åœ¨APåœºæ™¯,å½“æŸ¥è¯¢æ—¶é—´è·¨åº¦æ¯”è¾ƒå¤§æ—¶,ä¼ ç»Ÿçš„SQL:<code>select x from table where x order by time desc limit 10</code> è¿™ç§æ–¹å¼ä¼šå¯¼è‡´æŸ¥è¯¢æ€§èƒ½éå¸¸ä½,è€Œä¸”æ¶ˆè€—å¤§é‡çš„ClickHouseèµ„æºã€‚
é’ˆå¯¹è¿™ç§å¸¦è¶‹åŠ¿å›¾+æ˜ç»†çš„åœºæ™¯æˆ‘ä»¬åšäº†æ€§èƒ½ä¼˜åŒ–,å……åˆ†å‘æŒ¥ClickHouseçš„APèƒ½åŠ›ã€‚ä¼šå°†æ‰§è¡Œæ‹†åˆ†ä¸ºä¸¤æ­¥:</p><ol><li>åŸºäºCk èšåˆèƒ½åŠ›,æŸ¥è¯¢å‡ºæ¯åˆ†é’Ÿæ»¡è¶³æ¡ä»¶çš„æ—¥å¿—æ•°é‡</li><li>åŸºäºæ¯åˆ†é’Ÿçš„æ—¥å¿—æ•°é‡è‡ªåŠ¨è£å‰ªæ—¥å¿—æœç´¢çš„æ—¶é—´è·¨åº¦,æ¯”å¦‚ä¸€åˆ†é’Ÿå†…çš„æ—¥å¿—æ¡æ•°å°±æ»¡è¶³äº†è¦æ±‚,åˆ™æŸ¥è¯¢æ˜ç»†æ—¶è‡ªåŠ¨ç¼©å‡åˆ°1åˆ†é’Ÿçš„è·¨åº¦ã€‚</li></ol><p>åŸºäºæŸ¥è¯¢æ—¶é—´çš„è‡ªåŠ¨è£å‰ªåŠŸèƒ½,ä¼šä½¿å¾—Discoverç‰ˆæœ¬æŸ¥è¯¢æ€§èƒ½æœ‰è´¨çš„æå‡ä¸”å¯¹ClickHouseçš„cpuå ç”¨æœ‰å¾ˆå¤§çš„ä¼˜åŒ–ã€‚</p><p><img src="https://oss.17usoft.com/infra-github/ckibana15.png" alt="Untitled"/></p><p>å¦‚ä¸Šå›¾,ä¸€ä¸ªDiscoveræŸ¥è¯¢æ‹†æˆäº†3ä¸ªsql:</p><ol><li>è®¡ç®—æ˜¯å¦éœ€è¦é‡‡æ ·</li><li>ç»Ÿè®¡æ¯åˆ†é’Ÿçš„æ—¥å¿—æ•°</li><li>è‡ªåŠ¨è£å‰ªæŸ¥è¯¢æ—¶é—´èŒƒå›´</li></ol><h2>4 Nginxæ—¥å¿—ç›¸å…³ä½¿ç”¨æ¡ˆä¾‹</h2><h4>Clickhouseè¡¨ç»“æ„</h4><pre><code class="language-CREATE" metastring="TABLE bjops.ops_bjtlblog_local">(
`@timestamp` UInt64,
`X-Request-Id` String,
`addr` String,
`ap_area` String,
`byte` Int64,
`bytes_recv` Int64,
`Bbtes_sent` Int64,
`content-type` String,
`content_length` Int64,
`crp` String,
`csi` String,
`cspanid` String,
`difftime` Int32,
`error_body` String,
`error_client` String,
`error_host` String,
`error_request` String,
`error_server` String,
`error_upstream` String,
`forwarded` String,
`host` String,
`hostname` String,
`idc` LowCardinality(String),
`index_name` LowCardinality(String),
`ip` String,
`logant_idc` LowCardinality(String),
`logant_type` LowCardinality(String),
`origin_ip` String,
`referer` String,
`remote_port` String,
`request_method` LowCardinality(String),
`request_time` Int64,
`request_uri` String,
`request_url` String,
`scheme` String,
`server_addr` String,
`server_name` String,
`server_port` String,
`server_protocol` String,
`source` String,
`sspanid` String,
`st` String,
`status` Int32,
`timeuse` Float64,
`traceid` String,
`type` String,
`ua` String,
`up_addr` String,
`up_status` Int32,
`upstream_name` String,
`upstream_response_time` Int32,
`worker_pid` String,
`ck_assembly_extension` String,
`bytes_sent` Int64,
INDEX timestamp_index `@timestamp` TYPE minmax GRANULARITY 8192
)
ENGINE = MergeTree
PARTITION BY (toYYYYMMDD(toDateTime(`@timestamp` / 1000, &#x27;Asia/Shanghai&#x27;)), toHour(toDateTime(`@timestamp` / 1000, &#x27;Asia/Shanghai&#x27;)))
ORDER BY (host, request_uri, intHash64(`@timestamp`))
SAMPLE BY intHash64(`@timestamp`)
SETTINGS in_memory_parts_enable_wal = 0, index_granularity = 8192
</code></pre><p>åˆ‡è®°å°†<code>host</code>æ”¾ç½®åœ¨order byçš„ç¬¬ä¸€ä½ã€‚å› ä¸ºæŸ¥Nginxæ—¥å¿—å¤§å¤šæ•°æƒ…å†µä¸‹éœ€è¦æ ¹æ®<code>host</code>æŸ¥è¯¢ã€‚</p><h4>CKibanaæ‰€æœ‰é…ç½®</h4><pre><code>{
    &quot;Proxy&quot;: {
        &quot;ck&quot;: {
            &quot;url&quot;: &quot;ip:6321&quot;,
            &quot;user&quot;: &quot;user&quot;,
            &quot;pass&quot;: &quot;pass&quot;,
            &quot;defaultCkDatabase&quot;: &quot;db&quot;
        },
        &quot;es&quot;: {
            &quot;host&quot;: &quot;ip:31940&quot;
        },
        &quot;roundAbleMinPeriod&quot;: 120000,
        &quot;round&quot;: 20000,
        &quot;maxTimeRange&quot;: 86400000,
        &quot;blackIndexList&quot;: null,
        &quot;whiteIndexList&quot;: [&quot;ops_bjtlblog_all&quot;, &quot;other_index_all&quot;],
        &quot;enableMonitoring&quot;: true
    },
    &quot;query&quot;: {
        &quot;sampleIndexPatterns&quot;: [&quot;ops_bjtlblog_all&quot;],
        &quot;sampleCountMaxThreshold&quot;: 5000000,
        &quot;useCache&quot;: true,
        &quot;maxResultRow&quot;: 30000
    },
    &quot;threadPool&quot;: {
        &quot;msearchProperty&quot;: {
            &quot;coreSize&quot;: 4,
            &quot;queueSize&quot;: 10000
        },
        &quot;commonProperty&quot;: {
            &quot;coreSize&quot;: 4,
            &quot;queueSize&quot;: 10000
        }
    },
    &quot;defaultShard&quot;: 2
}
</code></pre><h4>çº¿ä¸Šæ•ˆæœå›¾</h4><p><img src="https://oss.17usoft.com/infra-github/ckibana12.png" alt="Untitled"/></p><p><img src="https://oss.17usoft.com/infra-github/ckibana13.png" alt="Untitled"/></p><h2>4 æ”¶ç›Š</h2><p>æˆªæ­¢åˆ°ç›®å‰ï¼Œå€ŸåŠ©CKibanaçš„æ ¸å¿ƒèƒ½åŠ›ï¼Œæˆ‘ä»¬å·²ç»å®Œæˆäº†æ‰€æœ‰Nginxè®¿é—®æ—¥å¿—å’Œä¸šåŠ¡è‡ªå®šä¹‰æ—¥å¿—å…¨é‡ä»ElasticSearchåˆ‡æ¢åˆ°Clickhouseï¼Œå­˜å‚¨æˆæœ¬é™ä¸ºåŸæ¥çš„30%ä»¥å†…ã€‚åŒæ—¶åŸºäºClickHouseçš„åˆ†å¸ƒå¼è¡¨èƒ½åŠ›å¯ä»¥åšåˆ°å³ä½¿åœ¨å•ä¸­å¿ƒæ•…éšœæ—¶æ—¥å¿—æŸ¥è¯¢ä¹Ÿä¸å—ä»»ä½•å½±å“ï¼Œæ— è®ºåœ¨æˆæœ¬è¿˜æ˜¯ç¨³å®šæ€§æ–¹é¢ç›¸æ¯”ElasticSearchéƒ½æœ‰äº†è¾ƒå¤§çš„æå‡ï¼Œå¹¶æ²¿ç”¨äº†çµæ´»å¼ºå¤§çš„åŸç”ŸKibanaä½œä¸ºå¯è§†åŒ–å·¥å…·ï¼Œå¯ä»¥è®©ç”¨æˆ·ç»§ç»­ä½¿ç”¨è‡ªå·±ä¹ æƒ¯çš„Kibanaé¢æ¿ä¾¿æ·åœ°è¿›è¡Œæ—¥å¿—æŸ¥è¯¢å’Œåˆ†æã€‚</p><h2>5 æœ€å</h2><p>åœ¨æˆ‘ä»¬æ—¥å¿—ç³»ç»Ÿä¸æ–­æ¼”è¿›çš„è¿‡ç¨‹ä¸­ç¦»ä¸å¼€ä¼—å¤šä¼˜ç§€çš„å¼€æºé¡¹ç›®ï¼Œç°åœ¨æˆ‘ä»¬ä¹Ÿå°†CKibana (ClickHouse Proxy for Kibana &amp; Clickhouse visualization tool) æ­£å¼å¼€æºäº†ï¼Œå¸Œæœ›èƒ½å¤Ÿå¸®åŠ©åˆ°æ›´å¤šçš„äººåŒæ—¶ä¹ŸæœŸæœ›èƒ½è·Ÿç¤¾åŒºä¸€èµ·å…±å»ºä¸æ–­å®Œå–„åŠŸèƒ½ä¸ç‰¹æ€§ï¼Œå……åˆ†å‘æŒ¥æ—¥å¿—åœºæ™¯ä¸‹Kibanaå¯è§†åŒ–+ClickHouseå­˜å‚¨è¿™å¯¹ç»„åˆçš„å¨åŠ›ï¼Œè®©å¤§å®¶ç”¨èµ·æ¥æ›´åŠ ä¸æ»‘ï¼Œæ¬¢è¿Starå’Œç»™æˆ‘ä»¬æISSUEã€‚</p><p>é¡¹ç›®Githubåœ°å€: <a href="https://github.com/TongchengOpenSource/ckibana">https://github.com/TongchengOpenSource/ckibana</a></p>]]></content:encoded>
        </item>
    </channel>
</rss>