<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.14">
<link rel="alternate" type="application/rss+xml" href="/ckibana-docs/en/blog/rss.xml" title="ùë™ùë≤ùíäùíÉùíÇùíèùíÇ RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/ckibana-docs/en/blog/atom.xml" title="ùë™ùë≤ùíäùíÉùíÇùíèùíÇ Atom Feed">
<link rel="alternate" type="application/rss+xml" href="/ckibana-docs/zh/blog/rss.xml" title="ùë™ùë≤ùíäùíÉùíÇùíèùíÇ RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/ckibana-docs/zh/blog/atom.xml" title="ùë™ùë≤ùíäùíÉùíÇùíèùíÇ Atom Feed"><title data-react-helmet="true">How to Build a Powerful Logging Platform Using Native Kibana and ClickHouse | ùë™ùë≤ùíäùíÉùíÇùíèùíÇ</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="http://CKibana.inf.17usoft.com/docs//ckibana-docs/en/blog/build-logging-platform-with-native-kibana-and-clickhouse"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><meta data-react-helmet="true" property="og:title" content="How to Build a Powerful Logging Platform Using Native Kibana and ClickHouse | ùë™ùë≤ùíäùíÉùíÇùíèùíÇ"><meta data-react-helmet="true" name="description" content="How to Build a Powerful Logging Platform Using Native Kibana and ClickHouse"><meta data-react-helmet="true" property="og:description" content="How to Build a Powerful Logging Platform Using Native Kibana and ClickHouse"><meta data-react-helmet="true" name="keywords" content="CKibana"><meta data-react-helmet="true" property="og:type" content="article"><meta data-react-helmet="true" property="article:published_time" content="2024-08-27T03:45:13.776Z"><meta data-react-helmet="true" property="article:tag" content="CKibana"><link data-react-helmet="true" rel="icon" href="/ckibana-docs/img/logo.svg"><link data-react-helmet="true" rel="canonical" href="http://CKibana.inf.17usoft.com/docs//ckibana-docs/en/blog/build-logging-platform-with-native-kibana-and-clickhouse"><link data-react-helmet="true" rel="alternate" href="http://CKibana.inf.17usoft.com/docs//ckibana-docs/en/blog/build-logging-platform-with-native-kibana-and-clickhouse" hreflang="en"><link data-react-helmet="true" rel="alternate" href="http://CKibana.inf.17usoft.com/docs//ckibana-docs/en/blog/build-logging-platform-with-native-kibana-and-clickhouse" hreflang="x-default"><link rel="stylesheet" href="/ckibana-docs/assets/css/styles.56a1642d.css">
<link rel="preload" href="/ckibana-docs/assets/js/runtime~main.8602d1de.js" as="script">
<link rel="preload" href="/ckibana-docs/assets/js/main.ba6bb3d8.js" as="script">
</head>
<body>
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,e("light"))}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" target="_self" href="/ckibana-docs/"><div class="navbar__logo"><img src="/ckibana-docs/img/ckibana-new.svg" alt="Site Logo" class="themedImage_TMUO themedImage--light_4Vu1" height="32" width="32"><img src="/ckibana-docs/img/ckibana-new.svg" alt="Site Logo" class="themedImage_TMUO themedImage--dark_uzRr" height="32" width="32"></div><b class="navbar__title">ùë™ùë≤ùíäùíÉùíÇùíèùíÇ</b></a></div><div class="navbar__items navbar__items--right"><div class="navbar__search searchBarContainer_I7kZ"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_Zg7X searchBarLoadingRing_J5Ez"><div></div><div></div><div></div><div></div></div><div class="searchHintContainer_CDc6"><kbd class="searchHint_2RRg">ctrl</kbd><kbd class="searchHint_2RRg">K</kbd></div></div><div class="toggle_iYfV toggle_2i4l toggleDisabled_xj38"><div class="toggleTrack_t-f2" role="button" tabindex="-1"><div class="toggleTrackCheck_mk7D"><span class="toggleIcon_pHJ9">üåú</span></div><div class="toggleTrackX_dm8H"><span class="toggleIcon_pHJ9">üåû</span></div><div class="toggleTrackThumb_W6To"></div></div><input type="checkbox" class="toggleScreenReader_h9qa" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg" style="max-width:100%"><div class="row"><main class="col col--10" itemscope="" itemtype="https://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><header><h1 class="blogPostTitle_RC3s" itemprop="headline">How to Build a Powerful Logging Platform Using Native Kibana and ClickHouse</h1><div class="blogPostData_A2Le margin-vert--md"><time datetime="2024-08-27T03:45:13.776Z" itemprop="datePublished">August 27, 2024</time> ¬∑ <!-- -->11 min read<!-- -->¬†<label id="umami-post-view-container"></label></div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_8c0z"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">CKibana-Team</span></a></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><blockquote><p>This article will introduce how to build a powerful logging platform based on native Kibana and Clickhouse.</p></blockquote><p>In the rapid development of business, the need to query and analyze various types of log data has caused a sharp increase in log storage scale. Traditional ELK and log systems based on ElasticSearch subsequently encounter many challenges in cost, stability, and performance. Increasingly, companies worldwide, such as Ctrip, Kuaishou, Bilibili, Cloudflare, and Uber, are switching their storage solutions to ClickHouse, experiencing significant benefits. Our log system has also begun migrating from ElasticSearch to ClickHouse, exploring and developing a comprehensive solution that fully caters to existing users&#x27; habits for a smooth transition.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="1--background-introduction">1  Background Introduction<a class="hash-link" href="#1--background-introduction" title="Direct link to heading">‚Äã</a></h2><p>Since migrating from ElasticSearch to ClickHouse in 2020, our company&#x27;s largest log system has experienced significant enhancements in cost-efficiency and stability. During the National Day period this year, it seamlessly managed over 500 billion logs daily, while reducing expenses to merely 30% of what was previously spent on the ElasticSearch solution.</p><p>In addition to this primary log system, our company operates several other logging systems, predominantly utilizing the open-source ELK stack. However, as these systems have scaled up, we&#x27;ve encountered escalating costs and stability challenges. Consequently, we are planning to transition the storage foundation of all logging systems to Clickhouse.</p><p>The industry has broadly discussed and shared insights on selecting and using Clickhouse for logging scenarios. However, this article will not focus on those details. For those interested, we encourage you to conduct your own research to find more in-depth information.</p><p>After switching to Clickhouse for log storage, the primary concern becomes enhancing the query UI user experience. Although many companies have developed custom query UIs after migrating to Clickhouse, ensuring a smooth transition that respects users&#x27; familiar habits from Kibana poses a significant challenge. This necessitates users to learn new syntax and UI interactions, inadvertently leading to substantial costs.</p><p>Thus, enabling users to transition to a new platform without incurring any learning costs is a particularly challenging issue.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="2-solution-introduction">2 Solution Introduction<a class="hash-link" href="#2-solution-introduction" title="Direct link to heading">‚Äã</a></h2><p>Our approach is actually quite simple and intuitive. We decided to insert an extra proxy layer between native Kibana and Elasticsearch. This proxy is responsible for the syntax translation between Elasticsearch and ClickHouse:
<img src="https://oss.17usoft.com/infra-github/ckibana02.png" alt="Untitled"></p><p>We developed our own Proxy (dubbed CKibana), which translates chart requests into ClickHouse syntax, fetches results from ClickHouse, and then simulates an Elasticsearch response to return to Kibana. This allows us to directly display data from ClickHouse in the native Kibana interface. Beyond syntax translation, we also tackled many real-world challenges.</p><p>Considering the limitations of ClickHouse&#x27;s query concurrency capabilities, we retained Elasticsearch. This Elasticsearch can be used for advanced features such as result caching and storing metadata related to Kibana, and it is very lightweight.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="3-how-to-use-ckibana">3 How to Use CKibana<a class="hash-link" href="#3-how-to-use-ckibana" title="Direct link to heading">‚Äã</a></h2><h3 class="anchor anchorWithStickyNavbar_y2LR" id="components">Components<a class="hash-link" href="#components" title="Direct link to heading">‚Äã</a></h3><ol><li>Kibana: Used to provide a UI display for business purposes.</li><li>ElasticSearch: Used for storing Kibana metadata and for query caching among other advanced features.</li><li>ClickHouse: The storage system where the actual log data is stored.</li><li>CKibana: Provides Proxy and other advanced functionalities, enabling users to query ClickHouse data directly on the native Kibana.</li></ol><h3 class="anchor anchorWithStickyNavbar_y2LR" id="getting-started">Getting Started<a class="hash-link" href="#getting-started" title="Direct link to heading">‚Äã</a></h3><h4 class="anchor anchorWithStickyNavbar_y2LR" id="launching-ckibana">Launching CKibana<a class="hash-link" href="#launching-ckibana" title="Direct link to heading">‚Äã</a></h4><p>To start using CKibana, you&#x27;ll first need to configure it with the necessary Elasticsearch details.</p><p><img src="https://oss.17usoft.com/infra-github/ckibana03.png" alt="Untitled"></p><p>Once you have your configuration set up, ensure that you have JDK 17 or higher installed on your system for CKibana to run. You can then launch CKibana with the following command:</p><p><code>java -jar ckibana.jar</code></p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="kibana-configuration">Kibana Configuration<a class="hash-link" href="#kibana-configuration" title="Direct link to heading">‚Äã</a></h4><p>To modify the Kibana configuration, change the Elasticsearch address to the CKibana addressÔºö
<img src="https://oss.17usoft.com/infra-github/ckibana04.png" alt="Untitled"></p><p>At this point, Kibana is fully functional and can use CKibana as an Elasticsearch ProxyÔºö
<img src="https://oss.17usoft.com/infra-github/ckibana05.png" alt="Untitled"></p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="configuring-clickhouse-connection-information-and-index-whitelist">Configuring ClickHouse Connection Information and Index Whitelist<a class="hash-link" href="#configuring-clickhouse-connection-information-and-index-whitelist" title="Direct link to heading">‚Äã</a></h4><p>Set up the ClickHouse connection:</p><p><code>curl --location --request POST &#x27;localhost:8080/config/updateCk?url=ckUrl&amp;user=default&amp;pass=default&amp;defaultCkDatabase=ops&#x27;</code></p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="configure-the-index-to-switch-to-clickhouse">Configure the index to switch to ClickHouse<a class="hash-link" href="#configure-the-index-to-switch-to-clickhouse" title="Direct link to heading">‚Äã</a></h4><p><code>curl --location --request POST &#x27;localhost:8080/config/updateWhiteIndexList?list=index1,index2&#x27;</code></p><p>The corresponding relationship between field types in ElasticSearch and ClickHouse is as follows:</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="create-index-pattern">Create index pattern<a class="hash-link" href="#create-index-pattern" title="Direct link to heading">‚Äã</a></h4><p><img src="https://oss.17usoft.com/infra-github/ckibana06.png" alt="Untitled"></p><p>Key Points to Note:</p><ol><li>First, ensure that the input index pattern matches the ClickHouse table exactly; the index pattern and the ClickHouse table name must be an exact match.</li><li>If the corresponding table cannot be selected, you can troubleshoot based on the SQL in the CKibana logs to see if the corresponding table can be queried.</li><li>Pay attention to the time field; otherwise, the time field will not be selectable. The selection logic is as follows:</li></ol><ul><li>Fields of the Date type, such as DateTime64, will be considered as time types.</li><li>Field names containing &quot;time&quot;, for example (@timestamp UInt64), will be considered as time types.</li></ul><p>In either of these two cases, if any one condition is met, the field will be considered a time field. If you are unable to select a time field, it&#x27;s necessary to check whether the fields in the ClickHouse table comply with the matching logic.</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="here-we-go">Here we go<a class="hash-link" href="#here-we-go" title="Direct link to heading">‚Äã</a></h4><p>After configuring the index pattern, you can now make full use of Kibana&#x27;s visual analysis capabilities<img src="https://oss.17usoft.com/infra-github/ckibana07.png" alt="Untitled"></p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="advanced-features">Advanced Features<a class="hash-link" href="#advanced-features" title="Direct link to heading">‚Äã</a></h3><h4 class="anchor anchorWithStickyNavbar_y2LR" id="sampling">Sampling<a class="hash-link" href="#sampling" title="Direct link to heading">‚Äã</a></h4><p>Most of Kibana&#x27;s charts focus on trends. When the result set is too large, it consumes more ClickHouse resources. We provide a sampling feature that ensures the chart trends are close to actual trends while effectively controlling the use of ClickHouse resources, especially when dealing with large datasets.</p><p>Note:</p><ul><li>The corresponding ClickHouse table needs to be created according to the ck sampling table requirements.<a href="https://clickhouse.com/docs/en/sql-reference/statements/select/sample" target="_blank" rel="noopener noreferrer">clickhouse sample</a></li><li>If the sampling threshold is set too low, it can result in a significant difference between the reconstructed values and the true values. We have set our online sampling threshold to 5 million.</li></ul><p>Enabling sampling requires two steps:</p><ol><li>Configure the tables to be sampled.</li><li>Update the sampling threshold. Sampling is triggered when the result set exceeds this threshold.</li></ol><p>Sampling logic: <code>Math.max(0.01, Double.parseDouble(String.format(&quot;%.5f&quot;, sampleParam.getSampleCountMaxThreshold() * 1.00 / sampleParam.getSampleTotalCount())))</code></p><p><img src="https://oss.17usoft.com/infra-github/ckibana08.png" alt="Untitled"></p><p>Expanding the response from the rate limiter, you can see the sampling value.</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="time-rounding--caching">Time Rounding + Caching<a class="hash-link" href="#time-rounding--caching" title="Direct link to heading">‚Äã</a></h4><p>When an issue occurs online, a large number of SRE and business colleagues need to query the nginx logs for troubleshooting, and their query conditions are mostly the same. However, ClickHouse aims to achieve the best query performance by utilizing as many CPUs as possible for computations. This situation leads to ClickHouse&#x27;s CPU usage spiking to full capacity. Moreover, under continuous retries by colleagues, the CPU cannot recover.</p><p>Therefore, we implemented a feature for time rounding + caching.</p><p>Time Rounding: For instance, setting rounding to 20s means that the second&#x27;s precision in the query time conditions will be %20, effectively introducing a maximum delay of 20s for data queries.With time rounding in place, a large number of query conditions become identical. At this point, enabling result caching can significantly alleviate the pressure on ClickHouse.</p><p>Set up time rounding:
<code>curl --location --request POST &#x27;localhost:8080/config/updateRoundAbleMinPeriod?roundAbleMinPeriod=20000&#x27; Âçï‰Ωçms</code></p><p>Enable caching:
<code>curl --location --request POST &#x27;localhost:8080/config/updateUseCache?useCache=true&#x27;</code>
<img src="https://oss.17usoft.com/infra-github/ckibana09.png" alt="Untitled"></p><p>Whether the cache is hit can be seen in the response structure.</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="query-monitoring--blacklisting">Query Monitoring + Blacklisting<a class="hash-link" href="#query-monitoring--blacklisting" title="Direct link to heading">‚Äã</a></h4><p>Kibana&#x27;s query syntax is relatively flexible, but some queries can consume substantial resources from ClickHouse. Therefore, we have implemented monitoring for all queries and their execution times. This allows us to easily view which queries have been performed and set up blacklisting controls for them. By doing this, we can restrict queries that are not very efficient.</p><p>Enable monitoring:</p><p><code>curl --location --request POST &#x27;localhost:8080/config/updateEnableMonitoring?enableMonitoring=true&#x27;</code></p><p><img src="https://oss.17usoft.com/infra-github/ckibana10.png" alt="Untitled"></p><p>As shown in the figure above, we can monitor the details, syntax, and execution time of each query.</p><p><img src="https://oss.17usoft.com/infra-github/ckibana11.png" alt="Untitled"></p><p>This allows us to leverage Kibana&#x27;s powerful built-in chart features for more intuitive analysis.</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="query-timerange-limits">Query TimeRange Limits<a class="hash-link" href="#query-timerange-limits" title="Direct link to heading">‚Äã</a></h4><p>Often, when users want to view the latest trends based on certain conditions, they might directly query data for recent periods, such as the last 7 days. This can lead to significant resource consumption. To manage this, CKibana has implemented a maximum time range for queries, which helps in limiting usage and conserving resources.</p><p><code>curl --location --request POST &#x27;localhost:8080/config/updateMaxTimeRange?maxTimeRange=864000000&#x27; Âçï‰Ωçms</code></p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="keyword-query">keyword Query<a class="hash-link" href="#keyword-query" title="Direct link to heading">‚Äã</a></h4><p>To better align with ElasticSearch usage conventions, a <code>field.keyword</code> query is equivalent to an exact search on the field, whereas without .keyword it implies a fuzzy search.</p><p>For example, <code>host.keyword:&quot;www.baidu.com&quot;</code> when translated into SQL becomes:<code>host=&quot;www.baidu.com&quot;</code>.</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="discover-performance-optimization">Discover Performance Optimization<a class="hash-link" href="#discover-performance-optimization" title="Direct link to heading">‚Äã</a></h4><p>ClickHouse is highly suitable for analytical processing (AP) scenarios, particularly when large time spans are involved in queries. Traditional SQL commands like <code>select x from table where x order by time desc limit 10</code> can lead to very low query performance and consume a significant amount of ClickHouse resources.</p><p>To address scenarios that involve trend graphs plus details, we have optimized performance to fully leverage ClickHouse&#x27;s AP capabilities. This optimization involves splitting the execution into two steps:</p><ol><li>Leveraging ClickHouse&#x27;s aggregation capabilities to query the number of logs that meet the criteria per minute.</li><li>Based on the number of logs per minute, automatically trimming the log search time span. For instance, if the number of logs within a minute fulfills the requirement, then the query detail time span is automatically reduced to one minute.</li></ol><p>This feature of automatically trimming the query time leads to a significant improvement in the query performance of the Discover version and greatly optimizes CPU usage in ClickHouse.</p><p><img src="https://oss.17usoft.com/infra-github/ckibana15.png" alt="Untitled"></p><p>As illustrated above, a Discover query is divided into three SQL statements:</p><ol><li>Determine whether sampling is needed</li><li>Count the number of logs per minute</li><li>Automatically trim the query time range</li></ol><h2 class="anchor anchorWithStickyNavbar_y2LR" id="4-usage-scenarios-nginx-logs">4 Usage scenarios: Nginx logs<a class="hash-link" href="#4-usage-scenarios-nginx-logs" title="Direct link to heading">‚Äã</a></h2><h4 class="anchor anchorWithStickyNavbar_y2LR" id="clickhouse-table">Clickhouse Table<a class="hash-link" href="#clickhouse-table" title="Direct link to heading">‚Äã</a></h4><div class="codeBlockContainer_J+bg language-CREATE theme-code-block"><div class="codeBlockContent_csEI CREATE"><pre tabindex="0" class="prism-code language-CREATE codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">`@timestamp` UInt64,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">`X-Request-Id` String,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">`addr` String,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">`ap_area` String,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">`byte` Int64,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">`bytes_recv` Int64,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">`Bbtes_sent` Int64,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">`content-type` String,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">`content_length` Int64,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">`crp` String,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">`csi` String,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">`cspanid` String,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">`difftime` Int32,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">`error_body` String,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">`error_client` String,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">`error_host` String,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">`error_request` String,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">`error_server` String,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">`error_upstream` String,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">`forwarded` String,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">`host` String,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">`hostname` String,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">`idc` LowCardinality(String),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">`index_name` LowCardinality(String),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">`ip` String,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">`logant_idc` LowCardinality(String),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">`logant_type` LowCardinality(String),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">`origin_ip` String,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">`referer` String,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">`remote_port` String,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">`request_method` LowCardinality(String),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">`request_time` Int64,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">`request_uri` String,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">`request_url` String,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">`scheme` String,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">`server_addr` String,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">`server_name` String,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">`server_port` String,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">`server_protocol` String,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">`source` String,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">`sspanid` String,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">`st` String,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">`status` Int32,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">`timeuse` Float64,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">`traceid` String,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">`type` String,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">`ua` String,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">`up_addr` String,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">`up_status` Int32,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">`upstream_name` String,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">`upstream_response_time` Int32,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">`worker_pid` String,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">`ck_assembly_extension` String,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">`bytes_sent` Int64,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">INDEX timestamp_index `@timestamp` TYPE minmax GRANULARITY 8192</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">ENGINE = MergeTree</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">PARTITION BY (toYYYYMMDD(toDateTime(`@timestamp` / 1000, &#x27;Asia/Shanghai&#x27;)), toHour(toDateTime(`@timestamp` / 1000, &#x27;Asia/Shanghai&#x27;)))</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">ORDER BY (host, request_uri, intHash64(`@timestamp`))</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">SAMPLE BY intHash64(`@timestamp`)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">SETTINGS in_memory_parts_enable_wal = 0, index_granularity = 8192</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Always place <code>host</code> at the first position in the ORDER BY clause, as most Nginx log queries require sorting based on the <code>host</code>.</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="ckibana-configuration">CKibana Configuration<a class="hash-link" href="#ckibana-configuration" title="Direct link to heading">‚Äã</a></h4><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">{</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;Proxy&quot;: {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;ck&quot;: {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;url&quot;: &quot;ip:6321&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;user&quot;: &quot;user&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;pass&quot;: &quot;pass&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;defaultCkDatabase&quot;: &quot;db&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;es&quot;: {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;host&quot;: &quot;ip:31940&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;roundAbleMinPeriod&quot;: 120000,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;round&quot;: 20000,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;maxTimeRange&quot;: 86400000,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;blackIndexList&quot;: null,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;whiteIndexList&quot;: [&quot;ops_bjtlblog_all&quot;, &quot;other_index_all&quot;],</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;enableMonitoring&quot;: true</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;query&quot;: {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;sampleIndexPatterns&quot;: [&quot;ops_bjtlblog_all&quot;],</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;sampleCountMaxThreshold&quot;: 5000000,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;useCache&quot;: true,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;maxResultRow&quot;: 30000</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;threadPool&quot;: {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;msearchProperty&quot;: {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;coreSize&quot;: 4,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;queueSize&quot;: 10000</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;commonProperty&quot;: {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;coreSize&quot;: 4,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;queueSize&quot;: 10000</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;defaultShard&quot;: 2</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_y2LR" id="use-cases">Use Cases<a class="hash-link" href="#use-cases" title="Direct link to heading">‚Äã</a></h4><p><img src="https://oss.17usoft.com/infra-github/ckibana12.png" alt="Untitled"></p><p><img src="https://oss.17usoft.com/infra-github/ckibana13.png" alt="Untitled"></p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="4-benefits">4 Benefits<a class="hash-link" href="#4-benefits" title="Direct link to heading">‚Äã</a></h2><p>As of now, by leveraging CKibana&#x27;s core capabilities, we have successfully completed the full migration of all Nginx access logs and business-customized logs from Elasticsearch to Clickhouse, reducing our storage costs to below 30% of the original. Moreover, thanks to ClickHouse&#x27;s distributed table capabilities, log queries remain unaffected even in the event of a single center failure, offering significant improvements over Elasticsearch in both cost and stability. We have also continued to use the flexible and powerful native Kibana as our visualization tool, allowing users to conveniently perform log queries and analyses using their familiar Kibana dashboard.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="5-finally">5 Finally<a class="hash-link" href="#5-finally" title="Direct link to heading">‚Äã</a></h2><p>Our logging system&#x27;s continuous evolution owes much to numerous outstanding open-source projects. Having proven stable and reliable internally, we&#x27;re now excited to open-source the CKibana project. We also look forward to collaborating with the community to continuously enhance its functionality, fully leveraging the Kibana visualization and ClickHouse storage combination for log analysis.</p><p>Github Repo: <a href="https://github.com/TongchengOpenSource/ckibana/" target="_blank" rel="noopener noreferrer">https://github.com/TongchengOpenSource/ckibana/</a></p><p>We hope you find it useful and welcome your feedback. Thanks~</p></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_2lop"><div class="col"><b>Tags:</b><ul class="tags_NBRY padding--none margin-left--sm"><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/ckibana-docs/en/blog/tags/c-kibana">CKibana</a></li></ul></div></footer></article></main><div class="col col--2"><div class="toc-wrapper" style="padding-inline-end:1rem;padding-inline-start:1rem"><h2>Contents</h2><div class="tableOfContents_vrFS thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1--background-introduction" class="table-of-contents__link toc-highlight">1  Background Introduction</a></li><li><a href="#2-solution-introduction" class="table-of-contents__link toc-highlight">2 Solution Introduction</a></li><li><a href="#3-how-to-use-ckibana" class="table-of-contents__link toc-highlight">3 How to Use CKibana</a><ul><li><a href="#components" class="table-of-contents__link toc-highlight">Components</a></li><li><a href="#getting-started" class="table-of-contents__link toc-highlight">Getting Started</a></li><li><a href="#advanced-features" class="table-of-contents__link toc-highlight">Advanced Features</a></li></ul></li><li><a href="#4-usage-scenarios-nginx-logs" class="table-of-contents__link toc-highlight">4 Usage scenarios: Nginx logs</a></li><li><a href="#4-benefits" class="table-of-contents__link toc-highlight">4 Benefits</a></li><li><a href="#5-finally" class="table-of-contents__link toc-highlight">5 Finally</a></li></ul></div></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/TongchengOpenSource/ckibana/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Github Issues<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://tongchengopensource.github.io/ckibana-docs" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>CKibana Documentation<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">Social</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/TongchengOpenSource/ckibana" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright ¬© 2024 TongchengOpenSource</div></div></div></footer></div>
<script src="/ckibana-docs/assets/js/runtime~main.8602d1de.js"></script>
<script src="/ckibana-docs/assets/js/main.ba6bb3d8.js"></script>
</body>
</html>